VersionControl=function(){this.upgradeURL="version.json";this.version=259;this.compatiable=259;this.lastVersion=null;this.loader=null;console.log("current version: "+this.version);};VersionControl.prototype.loadLastVersion=function(){$.ajax({cache:false,context:this,dataType:"json",error:this._loadErrorCallback,success:this._loadSuccessCallback,url:this.upgradeURL});};VersionControl.prototype._loadSuccessCallback=function(c,d,b){console.log("last version: "+c.version);this.lastVersion=c;var a=this.compareWithVersion(c);if(a===1){console.log("force upgrade");this.forceUpgrade();}else{if(a===-1){console.log("background upgrade");this.upgrade();}this.runCacheCodes();}};VersionControl.prototype._loadErrorCallback=function(a,b){console.error("load version error("+b+")");this.runCacheCodes();};VersionControl.prototype.compareWithVersion=function(a){if(this.version!==a.version){if(this.version>=a.compatiable){return -1;}return 1;}return 0;};VersionControl.prototype.forceUpgrade=function(){var a=this;this.upgrade(function(){a.runCacheCodes();});};VersionControl.prototype.upgrade=function(b){console.log("upgrade start");var a=this;this.loader=new this.Loader();this.loader.load(this.lastVersion.scripts,function(c){console.log("upgrade stop");a.loader=null;a.cacheCodes(c);b&&b(true);});};VersionControl.prototype.cacheCodes=function(b){if(b===false){console.warn("cache codes not equal to null");return;}this.clearCache();for(var a in b){localStorage.setItem(a,$.trim(b[a]));console.log("cached code: "+a);}};VersionControl.prototype.clearCache=function(){console.log("clear cache");var a=/^CODE_.+$/;for(var b in localStorage){if(a.test(b)===false){continue;}localStorage.removeItem(b);}};VersionControl.prototype.runCacheCodes=function(){if(localStorage.CODE_JAVASCRIPT){console.log("run cache codes");this.runCodes(localStorage.CODE_HTML,localStorage.CODE_JAVASCRIPT);}else{console.log("run local codes");this.runCodes(window.CODE_HTML,window.CODE_JAVASCRIPT);}};VersionControl.prototype.runCodes=function(html,javascript){if("ICCGAME_PASSPORT" in window){console.error("class ICCGAME_PASSPORT not exists.");return;}if(!html||!javascript){console.error("code html or javascript is empty");return;}$(document.body).html(html);try{window.eval(javascript);}catch(e){var lines=javascript.split("\n");for(var i=0;i<lines.length;i++){console.log((1+i)+": "+lines[i]);}console.warn(e);}};VersionControl.prototype.bootstrap=function(){console.log("load last version");this.loadLastVersion();};VersionControl.prototype.Loader=function(){this.actives=0;this.scripts=null;this.callback=null;};VersionControl.prototype.Loader.prototype.load=function(a,d){if(this.actives>0){throw"loader busy.";}this.callback=d;this.scripts=new Array();for(var c in a){for(var b in a[c]){this.loadScript(c,a[c][b]);}}};VersionControl.prototype.Loader.prototype.loadScript=function(c,b){console.log("load "+c+" scripts "+b);this.actives++;var a={no:this.actives,type:c,code:null};this.scripts.push(a);$.ajax({cache:false,context:this,dataType:"text",complete:function(){this.actives--;if(this.actives>0){return;}this.callback&&this.callback(this.getLoadedCodes());},success:function(d){a.code=d;},url:b});};VersionControl.prototype.Loader.prototype.getLoadedCodes=function(){this.scripts.sort(function(f,e){if(f.no>e.no){return 1;}return -1;});var a=new Object();for(var b in this.scripts){var d=this.scripts[b].code;var c="CODE_"+this.scripts[b].type;if(d===null){return false;}if(c in a===false){a[c]="";}a[c]+="\r\n\r\n"+$.trim(d);}return a;};